<mat-toolbar color="primary" class="topbar">
  <div class="brand">
    <span class="material-icons">savings</span>
    <span class="brand-title">Mesada em Casa</span>
  </div>
  <div class="spacer"></div>
  <button mat-icon-button (click)="openSettings()" aria-label="Configurações">
    <span class="material-icons">settings</span>
  </button>
  <div class="balance">
    <span class="label">XP disponível</span>
    <span class="value">{{ balance() }} XP</span>
  </div>
</mat-toolbar>

<main class="page">
  <section class="hero">
    <div>
      <p class="eyebrow">Controle de mesada</p>
      <h1>Transforme tarefas em conquistas.</h1>
      <p class="subtitle">
        Cadastre atividades, defina recompensas e acompanhe o XP de forma simples.
        Tudo fica salvo no seu navegador.
      </p>
    </div>
    <mat-card class="summary-card">
      <div class="summary-layout">
        <div class="avatar-lg">
          <img [src]="avatarSrc()" alt="Avatar do nível" />
        </div>
        <div class="summary-content">
          <div class="level-row">
            <div>
              <p class="summary-label">Nível atual</p>
              <p class="summary-value">Nível {{ level() }}</p>
            </div>
            <div class="level-meta">
              <p class="summary-label">Próximo nível</p>
              <p class="summary-value">{{ xpToNext() }} XP</p>
            </div>
          </div>
          <mat-progress-bar
            color="primary"
            mode="determinate"
            [value]="progressPercent()"
          ></mat-progress-bar>
          <div class="summary-row">
            <div>
              <p class="summary-label">XP acumulado</p>
              <p class="summary-value">{{ earned() }} XP</p>
            </div>
            <div>
              <p class="summary-label">XP gasto</p>
              <p class="summary-value">{{ spent() }} XP</p>
            </div>
          </div>
          <mat-divider></mat-divider>
          <div class="summary-row">
            <div>
              <p class="summary-label">XP no ciclo {{ cycleLabel() }}</p>
              <p class="summary-value">{{ cycleEarned() }} XP</p>
            </div>
            <div>
              <p class="summary-label">Período atual</p>
              <p class="summary-value small">{{ cycleRangeLabel() }}</p>
            </div>
          </div>
          @if (previousCycleEarned() !== null) {
            <mat-divider></mat-divider>
            <div class="summary-row">
              <div>
                <p class="summary-label">XP ciclo anterior</p>
                <p class="summary-value">{{ previousCycleEarned() }} XP</p>
              </div>
              <div>
                <p class="summary-label">Período anterior</p>
                <p class="summary-value small">{{ previousCycleLabel() }}</p>
              </div>
            </div>
          }
        </div>
      </div>
    </mat-card>
  </section>

  <section class="grid">
    <mat-card class="panel">
      <h2>Tarefas</h2>
      <form [formGroup]="taskForm" (ngSubmit)="addTask()" class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Descrição da tarefa</mat-label>
          <input matInput formControlName="title" placeholder="Arrumar a cama" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>XP da tarefa</mat-label>
          <input matInput type="number" formControlName="points" min="1" />
        </mat-form-field>
        <button mat-flat-button color="primary" type="submit" [disabled]="taskForm.invalid">
          Adicionar tarefa
        </button>
      </form>

      <div class="list-header">
        <span>Atividade</span>
        <span>XP</span>
        <span>Status</span>
      </div>
      @if (tasks().length === 0) {
        <p class="empty-state">Nenhuma tarefa cadastrada ainda.</p>
      }
      @for (task of tasks(); track task.id) {
        <div class="item-row">
          <div class="item-main">
            <span class="item-title">{{ task.title }}</span>
            <button mat-icon-button color="primary" (click)="toggleTask(task)">
              <span class="material-icons">
                {{ todayDoneIds().has(task.id) ? 'undo' : 'check_circle' }}
              </span>
            </button>
          </div>
          <span>{{ task.points }} XP</span>
          <span class="status" [class.done]="todayDoneIds().has(task.id)">
            {{ todayDoneIds().has(task.id) ? 'Concluída hoje' : 'Disponível hoje' }}
          </span>
          <button mat-icon-button class="danger" (click)="removeTask(task)">
            <span class="material-icons">delete</span>
          </button>
        </div>
      }
    </mat-card>

    <mat-card class="panel">
      <h2>Recompensas</h2>
      <form [formGroup]="rewardForm" (ngSubmit)="addReward()" class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Recompensa</mat-label>
          <input matInput formControlName="title" placeholder="Cinema" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Custo em XP</mat-label>
          <input matInput type="number" formControlName="cost" min="1" />
        </mat-form-field>
        <button mat-flat-button color="primary" type="submit" [disabled]="rewardForm.invalid">
          Adicionar recompensa
        </button>
      </form>

      <div class="list-header">
        <span>Recompensa</span>
        <span>XP</span>
        <span>Status</span>
      </div>
      @if (rewards().length === 0) {
        <p class="empty-state">Nenhuma recompensa cadastrada ainda.</p>
      }
      @for (reward of rewards(); track reward.id) {
        <div class="item-row">
          <div class="item-main">
            <span class="item-title">{{ reward.title }}</span>
            <button
              mat-icon-button
              color="primary"
              (click)="redeemReward(reward)"
              [disabled]="reward.redeemedAt || balance() < reward.cost"
            >
              <span class="material-icons">redeem</span>
            </button>
          </div>
          <span>{{ reward.cost }} XP</span>
          <span class="status" [class.done]="reward.redeemedAt">
            {{ reward.redeemedAt ? 'Resgatada' : 'Disponível' }}
          </span>
          <button mat-icon-button class="danger" (click)="removeReward(reward)">
            <span class="material-icons">delete</span>
          </button>
        </div>
      }
    </mat-card>
  </section>
</main>
